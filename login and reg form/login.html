<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
      integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <main>
      <form>
        <input id="userInp" placeholder="enter username" type="text" />
        <br />
        <input id="passInp" placeholder="enter password" type="password" />
        <br />
        <div class="custom-control custom-switch">
          <input
            type="checkbox"
            class="custom-control-input"
            id="customSwitch1"
          />
          <label class="custom-control-label" for="customSwitch1"
            >keep me logged in</label
          >
        </div>
        <button id="sub_btn">LogIn</button>
        <a href="./register.html">want to register</a>
      </form>
    </main>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDSJjVlLma734LDSl0VUdGCjEJynNG51jg",
        authDomain: "authentication-f967b.firebaseapp.com",
        databaseURL: "https://authentication-f967b-default-rtdb.firebaseio.com",
        projectId: "authentication-f967b",
        storageBucket: "authentication-f967b.appspot.com",
        messagingSenderId: "262842114705",
        appId: "1:262842114705:web:8b2344e5252e75190a5530",
        measurementId: "G-4SZG49Q2NV",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      import {
        getDatabase,
        ref,
        set,
        child,
        get,
        update,
        remove,
      } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

      const db = getDatabase();
      
      const username = document.getElementById("userInp");
      const pass = document.getElementById("passInp");
      const submit = document.getElementById("sub_btn");
      
        // handle empty password and email
      function AuthenticateUser(e){
        e.preventDefault();
        console.log("hello");
        const dbref = ref(db);
        
        get(child(dbref, "UsersList/" + username.value)).then((snapshot) => {
          if (snapshot.exists()) {
            
            let dbPass = decPass(snapshot.val().password);
            if ((dbPass = pass.value)) {
              login(snapshot.val());
            }
          } else {
            alert("user does not exist");
          }
        });
      }

      
      // decrypt password

      function decPass(dbpass) {
        var pass12 = CryptoJS.AES.decrypt(dbpass, pass.value);
        return pass12.toString(CryptoJS.enc.Utf8);
      }

      // login

      function login(user) {
       
        let keepLoggedIn = document.getElementById("customSwitch1");
        if (!keepLoggedIn) {
          sessionStorage.setItem("user", JSON.stringify(user)); // data will be sustain if session(website is open) is active
          window.location = "home.html";
        } else {
          localStorage.setItem("keepLoggedIn", "yes");
          localStorage.setItem("user", JSON.stringify(user));
          window.location = "home.html";
        }
      }

      submit.addEventListener("click",AuthenticateUser);

    </script>
  </body>
</html>
<!--
    CryptoJS is a js library used for encrypting and decrypting data
    CryptoJS.AES.encrypt(plain,secretkey)
    CryptoJS.AES.decrypt(encrypted,secretkey)
    decrypt(null)-> returns errror
-->
